openapi: 3.0.0
info:
  title: Array Polish - Array/TypedArray Edge Case Handling
  version: 0.1.0
  description: |
    Complete Array/TypedArray edge case handling for ES2024 compliance.
    Provides robust implementations of array methods with comprehensive
    edge case coverage for empty arrays, sparse arrays, boundary conditions,
    and iteration edge cases.
  contact:
    name: Corten JavaScript Runtime
    url: https://github.com/corten-javascript-runtime

x-component-metadata:
  component_name: array_polish
  component_type: core
  language: python
  dependencies:
    - shared_types
  performance_targets:
    all_operations: "<1ms for arrays <10K elements"
  test_requirements:
    minimum_tests: 50
    minimum_coverage: 85

x-requirements:
  functional:
    - id: FR-ES24-D-010
      description: Array method edge cases (empty, sparse)
      status: pending
    - id: FR-ES24-D-011
      description: TypedArray boundary conditions
      status: pending
    - id: FR-ES24-D-012
      description: Array.prototype.at() edge cases
      status: pending
    - id: FR-ES24-D-013
      description: Array.prototype.findLast/findLastIndex edge cases
      status: pending
    - id: FR-ES24-D-014
      description: Array iteration edge cases
      status: pending

components:
  schemas:
    Array:
      type: object
      description: JavaScript-style array representation
      properties:
        elements:
          type: array
          items:
            oneOf:
              - type: string
              - type: number
              - type: boolean
              - type: object
              - type: "null"
          description: Array elements (may contain holes for sparse arrays)
        length:
          type: integer
          minimum: 0
          description: Array length
        is_sparse:
          type: boolean
          description: Whether array contains holes (sparse array)
      required:
        - elements
        - length

    TypedArray:
      type: object
      description: TypedArray representation with specific element type
      properties:
        type:
          type: string
          enum:
            - Int8Array
            - Uint8Array
            - Uint8ClampedArray
            - Int16Array
            - Uint16Array
            - Int32Array
            - Uint32Array
            - Float32Array
            - Float64Array
            - BigInt64Array
            - BigUint64Array
          description: TypedArray type
        elements:
          type: array
          description: Typed array elements
        length:
          type: integer
          minimum: 0
          description: Array length
        byte_length:
          type: integer
          minimum: 0
          description: Byte length of the underlying buffer
        byte_offset:
          type: integer
          minimum: 0
          description: Byte offset in the underlying buffer
      required:
        - type
        - elements
        - length
        - byte_length
        - byte_offset

    Index:
      type: integer
      description: Array index (can be negative for reverse indexing)

    Predicate:
      type: object
      description: Predicate function for array searching
      properties:
        function_name:
          type: string
          description: Name of the predicate function
        parameters:
          type: array
          items:
            type: string
          description: Parameter names (element, index, array)
      required:
        - function_name

    ArrayAtResult:
      type: object
      description: Result of Array.prototype.at() operation
      properties:
        value:
          description: Element at the specified index, or undefined
          oneOf:
            - type: string
            - type: number
            - type: boolean
            - type: object
            - type: "null"
        is_undefined:
          type: boolean
          description: True if index is out of bounds
      required:
        - is_undefined

    FindLastResult:
      type: object
      description: Result of findLast operation
      properties:
        value:
          description: Last element matching predicate, or undefined
          oneOf:
            - type: string
            - type: number
            - type: boolean
            - type: object
            - type: "null"
        found:
          type: boolean
          description: Whether a matching element was found
      required:
        - found

    FindLastIndexResult:
      type: object
      description: Result of findLastIndex operation
      properties:
        index:
          type: integer
          description: Index of last matching element, or -1 if not found
        found:
          type: boolean
          description: Whether a matching element was found
      required:
        - index
        - found

    SparseArrayResult:
      type: object
      description: Result of sparse array handling
      properties:
        normalized_array:
          $ref: '#/components/schemas/Array'
        holes_removed:
          type: boolean
          description: Whether holes were removed during normalization
        original_holes:
          type: array
          items:
            type: integer
          description: Indices of holes in the original array
      required:
        - normalized_array
        - holes_removed

    EdgeCaseInfo:
      type: object
      description: Information about array edge cases detected
      properties:
        is_empty:
          type: boolean
          description: Array has zero elements
        is_sparse:
          type: boolean
          description: Array contains holes
        has_negative_zero:
          type: boolean
          description: Array contains -0
        has_nan:
          type: boolean
          description: Array contains NaN
        has_infinity:
          type: boolean
          description: Array contains Infinity or -Infinity
        has_undefined:
          type: boolean
          description: Array contains explicit undefined values
      required:
        - is_empty
        - is_sparse

    ErrorResponse:
      type: object
      description: Error response for invalid operations
      properties:
        error_type:
          type: string
          enum:
            - TypeError
            - RangeError
            - InvalidArrayError
            - InvalidPredicateError
            - InvalidIndexError
          description: Type of error
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          description: Additional error details
      required:
        - error_type
        - message

x-api-methods:
  ArrayEdgeCases.at:
    description: |
      Implements Array.prototype.at() with comprehensive edge case handling.
      Supports negative indices, boundary conditions, empty arrays, and sparse arrays.
    method_signature: "at(array: List, index: int) -> Any"
    parameters:
      - name: array
        schema:
          $ref: '#/components/schemas/Array'
        required: true
        description: Input array (may be empty or sparse)
      - name: index
        schema:
          $ref: '#/components/schemas/Index'
        required: true
        description: Index to access (supports negative indices)
    returns:
      schema:
        $ref: '#/components/schemas/ArrayAtResult'
      description: Element at index, or undefined if out of bounds
    edge_cases:
      - description: Empty array
        input:
          array: { elements: [], length: 0 }
          index: 0
        output:
          value: null
          is_undefined: true
      - description: Negative index within bounds
        input:
          array: { elements: [1, 2, 3], length: 3 }
          index: -1
        output:
          value: 3
          is_undefined: false
      - description: Negative index out of bounds
        input:
          array: { elements: [1, 2, 3], length: 3 }
          index: -5
        output:
          value: null
          is_undefined: true
      - description: Positive index out of bounds
        input:
          array: { elements: [1, 2, 3], length: 3 }
          index: 5
        output:
          value: null
          is_undefined: true
      - description: Sparse array - accessing hole
        input:
          array: { elements: [1, null, 3], length: 3, is_sparse: true }
          index: 1
        output:
          value: null
          is_undefined: true
      - description: Index at boundary (0)
        input:
          array: { elements: [42], length: 1 }
          index: 0
        output:
          value: 42
          is_undefined: false
      - description: Index at boundary (length-1)
        input:
          array: { elements: [1, 2, 3], length: 3 }
          index: 2
        output:
          value: 3
          is_undefined: false
    errors:
      - error_type: TypeError
        condition: array is not a valid array object
        message: "First argument must be an array"
      - error_type: TypeError
        condition: index is not an integer
        message: "Index must be an integer"
    performance:
      complexity: O(1)
      target: "<1ms for any array size"
    requirements:
      - FR-ES24-D-010
      - FR-ES24-D-012

  ArrayEdgeCases.find_last:
    description: |
      Implements Array.prototype.findLast() with comprehensive edge case handling.
      Searches array from end to beginning, returns last element matching predicate.
    method_signature: "find_last(array: List, predicate: Callable) -> Any"
    parameters:
      - name: array
        schema:
          $ref: '#/components/schemas/Array'
        required: true
        description: Input array to search
      - name: predicate
        schema:
          $ref: '#/components/schemas/Predicate'
        required: true
        description: Predicate function (element, index, array) -> bool
    returns:
      schema:
        $ref: '#/components/schemas/FindLastResult'
      description: Last element matching predicate, or undefined
    edge_cases:
      - description: Empty array
        input:
          array: { elements: [], length: 0 }
          predicate: { function_name: "always_true" }
        output:
          value: null
          found: false
      - description: No matching element
        input:
          array: { elements: [1, 2, 3], length: 3 }
          predicate: { function_name: "is_negative" }
        output:
          value: null
          found: false
      - description: Single matching element
        input:
          array: { elements: [1, 2, 3], length: 3 }
          predicate: { function_name: "equals_2" }
        output:
          value: 2
          found: true
      - description: Multiple matching elements (returns last)
        input:
          array: { elements: [1, 2, 3, 2, 1], length: 5 }
          predicate: { function_name: "equals_2" }
        output:
          value: 2
          found: true
      - description: Sparse array - skips holes
        input:
          array: { elements: [1, null, 3], length: 3, is_sparse: true }
          predicate: { function_name: "always_true" }
        output:
          value: 3
          found: true
      - description: All elements match (returns last)
        input:
          array: { elements: [1, 1, 1], length: 3 }
          predicate: { function_name: "equals_1" }
        output:
          value: 1
          found: true
      - description: Array with special values (NaN, -0, Infinity)
        input:
          array: { elements: [NaN, -0, Infinity], length: 3 }
          predicate: { function_name: "is_finite" }
        output:
          value: -0
          found: true
    errors:
      - error_type: TypeError
        condition: array is not a valid array object
        message: "First argument must be an array"
      - error_type: TypeError
        condition: predicate is not callable
        message: "Predicate must be a callable function"
      - error_type: InvalidPredicateError
        condition: predicate throws an exception
        message: "Predicate function threw an error"
    performance:
      complexity: O(n)
      target: "<1ms for arrays <10K elements"
    requirements:
      - FR-ES24-D-010
      - FR-ES24-D-013
      - FR-ES24-D-014

  ArrayEdgeCases.find_last_index:
    description: |
      Implements Array.prototype.findLastIndex() with comprehensive edge case handling.
      Searches array from end to beginning, returns index of last matching element.
    method_signature: "find_last_index(array: List, predicate: Callable) -> int"
    parameters:
      - name: array
        schema:
          $ref: '#/components/schemas/Array'
        required: true
        description: Input array to search
      - name: predicate
        schema:
          $ref: '#/components/schemas/Predicate'
        required: true
        description: Predicate function (element, index, array) -> bool
    returns:
      schema:
        $ref: '#/components/schemas/FindLastIndexResult'
      description: Index of last matching element, or -1 if not found
    edge_cases:
      - description: Empty array
        input:
          array: { elements: [], length: 0 }
          predicate: { function_name: "always_true" }
        output:
          index: -1
          found: false
      - description: No matching element
        input:
          array: { elements: [1, 2, 3], length: 3 }
          predicate: { function_name: "is_negative" }
        output:
          index: -1
          found: false
      - description: Single matching element
        input:
          array: { elements: [1, 2, 3], length: 3 }
          predicate: { function_name: "equals_2" }
        output:
          index: 1
          found: true
      - description: Multiple matching elements (returns last index)
        input:
          array: { elements: [1, 2, 3, 2, 1], length: 5 }
          predicate: { function_name: "equals_2" }
        output:
          index: 3
          found: true
      - description: Sparse array - skips holes
        input:
          array: { elements: [1, null, 3], length: 3, is_sparse: true }
          predicate: { function_name: "always_true" }
        output:
          index: 2
          found: true
      - description: Match at index 0
        input:
          array: { elements: [42, 1, 2], length: 3 }
          predicate: { function_name: "equals_42" }
        output:
          index: 0
          found: true
      - description: Match at last index
        input:
          array: { elements: [1, 2, 42], length: 3 }
          predicate: { function_name: "equals_42" }
        output:
          index: 2
          found: true
    errors:
      - error_type: TypeError
        condition: array is not a valid array object
        message: "First argument must be an array"
      - error_type: TypeError
        condition: predicate is not callable
        message: "Predicate must be a callable function"
      - error_type: InvalidPredicateError
        condition: predicate throws an exception
        message: "Predicate function threw an error"
    performance:
      complexity: O(n)
      target: "<1ms for arrays <10K elements"
    requirements:
      - FR-ES24-D-010
      - FR-ES24-D-013
      - FR-ES24-D-014

  ArrayEdgeCases.handle_sparse:
    description: |
      Handles sparse array edge cases with comprehensive normalization.
      Provides options for hole removal, hole preservation, or explicit undefined conversion.
    method_signature: "handle_sparse(array: List, mode: str = 'remove_holes') -> List"
    parameters:
      - name: array
        schema:
          $ref: '#/components/schemas/Array'
        required: true
        description: Input array (may be sparse)
      - name: mode
        schema:
          type: string
          enum:
            - remove_holes
            - preserve_holes
            - explicit_undefined
        required: false
        default: remove_holes
        description: |
          How to handle sparse array holes:
          - remove_holes: Remove holes, compacting array
          - preserve_holes: Keep holes as-is
          - explicit_undefined: Convert holes to explicit undefined
    returns:
      schema:
        $ref: '#/components/schemas/SparseArrayResult'
      description: Normalized array with hole handling information
    edge_cases:
      - description: Empty array
        input:
          array: { elements: [], length: 0 }
          mode: remove_holes
        output:
          normalized_array: { elements: [], length: 0 }
          holes_removed: false
          original_holes: []
      - description: Dense array (no holes)
        input:
          array: { elements: [1, 2, 3], length: 3, is_sparse: false }
          mode: remove_holes
        output:
          normalized_array: { elements: [1, 2, 3], length: 3 }
          holes_removed: false
          original_holes: []
      - description: Sparse array - remove holes
        input:
          array: { elements: [1, null, 3, null, 5], length: 5, is_sparse: true }
          mode: remove_holes
        output:
          normalized_array: { elements: [1, 3, 5], length: 3 }
          holes_removed: true
          original_holes: [1, 3]
      - description: Sparse array - preserve holes
        input:
          array: { elements: [1, null, 3], length: 3, is_sparse: true }
          mode: preserve_holes
        output:
          normalized_array: { elements: [1, null, 3], length: 3, is_sparse: true }
          holes_removed: false
          original_holes: [1]
      - description: Sparse array - explicit undefined
        input:
          array: { elements: [1, null, 3], length: 3, is_sparse: true }
          mode: explicit_undefined
        output:
          normalized_array: { elements: [1, undefined, 3], length: 3, is_sparse: false }
          holes_removed: true
          original_holes: [1]
      - description: All holes
        input:
          array: { elements: [null, null, null], length: 3, is_sparse: true }
          mode: remove_holes
        output:
          normalized_array: { elements: [], length: 0 }
          holes_removed: true
          original_holes: [0, 1, 2]
    errors:
      - error_type: TypeError
        condition: array is not a valid array object
        message: "First argument must be an array"
      - error_type: TypeError
        condition: mode is not a valid string
        message: "Mode must be a string"
      - error_type: RangeError
        condition: mode is not a recognized mode
        message: "Mode must be one of: remove_holes, preserve_holes, explicit_undefined"
    performance:
      complexity: O(n)
      target: "<1ms for arrays <10K elements"
    requirements:
      - FR-ES24-D-010
      - FR-ES24-D-014

  ArrayEdgeCases.detect_edge_cases:
    description: |
      Analyzes array for common edge cases and special values.
      Returns comprehensive edge case information.
    method_signature: "detect_edge_cases(array: List) -> EdgeCaseInfo"
    parameters:
      - name: array
        schema:
          $ref: '#/components/schemas/Array'
        required: true
        description: Array to analyze
    returns:
      schema:
        $ref: '#/components/schemas/EdgeCaseInfo'
      description: Edge case information
    edge_cases:
      - description: Empty array
        input:
          array: { elements: [], length: 0 }
        output:
          is_empty: true
          is_sparse: false
          has_negative_zero: false
          has_nan: false
          has_infinity: false
          has_undefined: false
      - description: Dense array with normal values
        input:
          array: { elements: [1, 2, 3], length: 3 }
        output:
          is_empty: false
          is_sparse: false
          has_negative_zero: false
          has_nan: false
          has_infinity: false
          has_undefined: false
      - description: Array with special values
        input:
          array: { elements: [1, NaN, -0, Infinity, undefined], length: 5 }
        output:
          is_empty: false
          is_sparse: false
          has_negative_zero: true
          has_nan: true
          has_infinity: true
          has_undefined: true
      - description: Sparse array
        input:
          array: { elements: [1, null, 3], length: 3, is_sparse: true }
        output:
          is_empty: false
          is_sparse: true
          has_negative_zero: false
          has_nan: false
          has_infinity: false
          has_undefined: false
    errors:
      - error_type: TypeError
        condition: array is not a valid array object
        message: "Argument must be an array"
    performance:
      complexity: O(n)
      target: "<1ms for arrays <10K elements"
    requirements:
      - FR-ES24-D-010
      - FR-ES24-D-014

x-typed-array-support:
  description: |
    All methods support TypedArray edge cases with appropriate boundary handling.
  supported_types:
    - Int8Array
    - Uint8Array
    - Uint8ClampedArray
    - Int16Array
    - Uint16Array
    - Int32Array
    - Uint32Array
    - Float32Array
    - Float64Array
    - BigInt64Array
    - BigUint64Array
  edge_cases:
    - description: TypedArray boundary values
      cases:
        - Int8Array min/max (-128, 127)
        - Uint8Array min/max (0, 255)
        - Float32Array special values (NaN, Infinity, -Infinity, -0)
    - description: TypedArray out-of-bounds access
      behavior: Returns undefined (same as regular arrays)
    - description: TypedArray with offset and length
      behavior: Respects byte_offset and length constraints
  requirements:
    - FR-ES24-D-011

x-test-coverage:
  categories:
    empty_arrays:
      description: Tests with empty arrays
      minimum_tests: 8
      examples:
        - at() on empty array
        - findLast() on empty array
        - findLastIndex() on empty array
        - handle_sparse() on empty array

    sparse_arrays:
      description: Tests with sparse arrays (holes)
      minimum_tests: 10
      examples:
        - at() accessing hole
        - findLast() skipping holes
        - findLastIndex() with holes
        - handle_sparse() modes (remove, preserve, explicit)

    boundary_conditions:
      description: Tests at array boundaries
      minimum_tests: 12
      examples:
        - at(0) and at(length-1)
        - at(-1) and at(-length)
        - at() out of bounds (positive and negative)
        - findLast/findLastIndex at boundaries

    special_values:
      description: Tests with NaN, -0, Infinity, undefined
      minimum_tests: 8
      examples:
        - Arrays containing NaN
        - Arrays containing -0
        - Arrays containing Infinity/-Infinity
        - Arrays with explicit undefined

    predicate_edge_cases:
      description: Tests with various predicate conditions
      minimum_tests: 8
      examples:
        - Predicate that always returns true
        - Predicate that always returns false
        - Predicate that throws error
        - Predicate with complex conditions

    typed_arrays:
      description: Tests with TypedArrays
      minimum_tests: 6
      examples:
        - TypedArray boundary values
        - TypedArray out-of-bounds
        - TypedArray special values (Float32Array NaN, Infinity)

x-quality-gates:
  test_coverage: "≥85%"
  test_count: "≥50 tests"
  performance: "<1ms for arrays <10K elements"
  code_quality:
    - No stub implementations
    - All edge cases handled
    - Comprehensive error handling
    - Defensive programming patterns
  documentation:
    - All methods documented
    - All edge cases documented
    - Performance characteristics documented
